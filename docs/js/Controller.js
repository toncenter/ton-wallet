!function(e){var t={};function s(a){if(t[a])return t[a].exports;var n=t[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=e,s.c=t,s.d=function(e,t,a){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(s.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)s.d(a,n,function(t){return e[t]}.bind(null,n));return a},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t){let s=null,a=null;const n=[],o=()=>{chrome.windows.create({url:"popup.html",type:"popup",width:400,height:600,top:0,left:window.innerWidth-400},e=>{this._popupId=e.id})},i=TonWeb.utils.BN,r=TonWeb.utils.nacl,d=TonWeb.utils.Address,l=TonWeb.utils.fromNano;const c=window.location.href.indexOf("testnet")>-1,h=!!(window.chrome&&chrome.runtime&&chrome.runtime.onConnect);class w{constructor(){this.myAddress=null,this.publicKeyHex=null,this.myMnemonicWords=null,this.balance=null,this.walletContract=null,this.transactions=[],this.updateIntervalId=0,this.lastTransactionTime=0,this.isContractInitialized=!1,this.sendingData=null,this.processingVisible=!1,this.ledgerApp=null,this.isLedger=!1,window.view&&(window.view.controller=this);this.sendToView("setIsTestnet",c),localStorage.removeItem("pwdHash"),this.ton=new TonWeb(new TonWeb.HttpProvider(c?"https://testnet.toncenter.com/api/v2/jsonRPC":"https://toncenter.com/api/v2/jsonRPC",{apiKey:h?"503af517296765c3f1729fcb301b063a00650a50a881eeaddb6307d5d45e21aa":"4f96a149e04e0821d20f9e99ee716e20ff52db7238f38663226b1c0f303003e0"})),this.myAddress=localStorage.getItem("address"),this.myAddress&&localStorage.getItem("words")?("true"===localStorage.getItem("isLedger")&&(this.isLedger=!0,this.publicKeyHex=localStorage.getItem("publicKey"),this.sendToView("setIsLedger",this.isLedger)),this.showMain()):(localStorage.clear(),this.sendToView("showScreen",{name:"start"}))}static async wordsToPrivateKey(e){const t=await TonWeb.mnemonic.mnemonicToKeyPair(e);return TonWeb.utils.bytesToBase64(t.secretKey.slice(0,32))}static async saveWords(e,t){localStorage.setItem("words",await async function(e,t){const s=(new TextEncoder).encode(t),a=await crypto.subtle.digest("SHA-256",s),n=crypto.getRandomValues(new Uint8Array(12)),o={name:"AES-GCM",iv:n},i=await crypto.subtle.importKey("raw",a,o,!1,["encrypt"]),r=(new TextEncoder).encode(e),d=await crypto.subtle.encrypt(o,i,r),l=Array.from(new Uint8Array(d)).map(e=>String.fromCharCode(e)).join(""),c=btoa(l);return Array.from(n).map(e=>("00"+e.toString(16)).slice(-2)).join("")+c}(e.join(","),t))}static async loadWords(e){return(await async function(e,t){const s=(new TextEncoder).encode(t),a=await crypto.subtle.digest("SHA-256",s),n=e.slice(0,24).match(/.{2}/g).map(e=>parseInt(e,16)),o={name:"AES-GCM",iv:new Uint8Array(n)},i=await crypto.subtle.importKey("raw",a,o,!1,["decrypt"]),r=atob(e.slice(24)),d=new Uint8Array(r.match(/[\s\S]/g).map(e=>e.charCodeAt(0))),l=await crypto.subtle.decrypt(o,i,d);return(new TextDecoder).decode(l)}(localStorage.getItem("words"),e)).split(",")}async getWallet(){return this.ton.provider.getWalletInfo(this.myAddress)}checkContractInitialized(e){return"active"===e.account_state}getBalance(e){return new i(e.balance)}async getTransactions(e=20){function t(e){if(!e.msg_data)return"";if("msg.dataText"!==e.msg_data["@type"])return"";const t=e.msg_data.text;return(new TextDecoder).decode(TonWeb.utils.base64ToBytes(t))}const s=[],a=await this.ton.getTransactions(this.myAddress,e);for(let e of a){let a=new i(e.in_msg.value);for(let t of e.out_msgs)a=a.sub(new i(t.value));let n="",o="",r="";e.in_msg.source?(n=e.in_msg.source,o=e.in_msg.destination,r=t(e.in_msg)):e.out_msgs.length&&(n=e.out_msgs[0].source,o=e.out_msgs[0].destination,r=t(e.out_msgs[0])),o&&s.push({amount:a.toString(),from_addr:n,to_addr:o,fee:e.fee.toString(),storageFee:e.storage_fee.toString(),otherFee:e.other_fee.toString(),comment:r,date:1e3*e.utime})}return s}async sign(e,t,s,a){let n=(await this.getWallet(this.myAddress)).seqno;n||(n=0);const o=a?a.secretKey:null;return this.walletContract.methods.transfer({secretKey:o,toAddress:e,amount:t,seqno:n,payload:s,sendMode:3})}async showCreated(){this.sendToView("showScreen",{name:"created"}),this.sendToView("disableCreated",!0),this.myMnemonicWords=await TonWeb.mnemonic.generateMnemonic();const e=await w.wordsToPrivateKey(this.myMnemonicWords),t=r.sign.keyPair.fromSeed(TonWeb.utils.base64ToBytes(e)),s=this.ton.wallet.all.v3R2;this.walletContract=new s(this.ton.provider,{publicKey:t.publicKey,wc:0}),this.myAddress=(await this.walletContract.getAddress()).toString(!0,!0,!0),localStorage.setItem("walletVersion","v3R2"),this.sendToView("disableCreated",!1)}async createPrivateKey(){this.showBackup(this.myMnemonicWords)}onBackupWalletClick(){this.afterEnterPassword=async e=>{this.showBackup(e)},this.sendToView("showPopup",{name:"enterPassword"})}showBackup(e){this.sendToView("showScreen",{name:"backup",words:e})}onBackupDone(){localStorage.getItem("words")?this.sendToView("showScreen",{name:"main"}):this.showCreatePassword()}async createLedger(e){let t;switch(e){case"hid":t=await TonWeb.ledger.TransportWebHID.create();break;case"ble":t=await TonWeb.ledger.BluetoothTransport.create();break;default:throw new Error("unknown transportType"+e)}t.setDebugMode(!0),this.isLedger=!0,this.ledgerApp=new TonWeb.ledger.AppTon(t,this.ton);const s=(await this.ledgerApp.getAppConfiguration()).version;if(console.log("ledgerAppConfig=",s),!s.startsWith("2"))throw alert("Please update your Ledger TON-app to v2.0.1 or upper or use old wallet version https://tonwallet.me/prev/"),new Error("outdated ledger ton-app version");const{publicKey:a}=await this.ledgerApp.getPublicKey(0,!1),n=new(0,this.ton.wallet.all.v3R1)(this.ton.provider,{publicKey:a,wc:0});this.walletContract=n;const o=await n.getAddress();this.myAddress=o.toString(!0,!0,!0),this.publicKeyHex=TonWeb.utils.bytesToHex(a)}async importLedger(e){await this.createLedger(e),localStorage.setItem("walletVersion",this.walletContract.getName()),localStorage.setItem("address",this.myAddress),localStorage.setItem("isLedger","true"),localStorage.setItem("ledgerTransportType",e),localStorage.setItem("words","ledger"),localStorage.setItem("publicKey",this.publicKeyHex),this.sendToView("setIsLedger",this.isLedger),this.sendToView("showScreen",{name:"readyToGo"})}showImport(){this.sendToView("showScreen",{name:"import"})}async import(e){if(this.myMnemonicWords=e,this.myMnemonicWords){const e=await w.wordsToPrivateKey(this.myMnemonicWords),t=r.sign.keyPair.fromSeed(TonWeb.utils.base64ToBytes(e));let s=[];for(let e of this.ton.wallet.list){const a=new e(this.ton.provider,{publicKey:t.publicKey,wc:0}),n=(await a.getAddress()).toString(!0,!0,!0),o=await this.ton.provider.getWalletInfo(n),r=this.getBalance(o);r.gt(new i(0))&&s.push({balance:r,clazz:e}),console.log(a.getName(),n,o,r.toString())}let a=this.ton.wallet.all.v3R2;s.length>0&&(s.sort((e,t)=>e.balance.cmp(t.balance)),a=s[s.length-1].clazz),await this.importImpl(t,a)}}async importImpl(e,t){this.walletContract=new t(this.ton.provider,{publicKey:e.publicKey,wc:0}),this.myAddress=(await this.walletContract.getAddress()).toString(!0,!0,!0),localStorage.setItem("walletVersion",this.walletContract.getName()),this.showCreatePassword()}showCreatePassword(){this.sendToView("showScreen",{name:"createPassword"})}async savePrivateKey(e){this.isLedger=!1,localStorage.setItem("isLedger","false"),localStorage.setItem("address",this.myAddress),await w.saveWords(this.myMnemonicWords,e),this.myMnemonicWords=null,this.sendToView("setIsLedger",this.isLedger),this.sendToView("showScreen",{name:"readyToGo"})}async onChangePassword(e,t){let s;try{s=await w.loadWords(e)}catch(e){return void this.sendToView("showChangePasswordError")}await w.saveWords(s,t),this.sendToView("closePopup")}async onEnterPassword(e){let t;try{t=await w.loadWords(e)}catch(e){return void this.sendToView("showEnterPasswordError")}this.afterEnterPassword(t)}showMain(){if(this.sendToView("showScreen",{name:"main",myAddress:this.myAddress}),!this.walletContract){const e=localStorage.getItem("walletVersion"),t=e?this.ton.wallet.all[e]:this.ton.wallet.default;this.walletContract=new t(this.ton.provider,{address:this.myAddress,wc:0})}this.updateIntervalId=setInterval(()=>this.update(),5e3),this.update(!0),this.sendToDapp("ton_accounts",[this.myAddress])}initDapp(){this.sendToDapp("ton_accounts",this.myAddress?[this.myAddress]:[]),this.doMagic("true"===localStorage.getItem("magic")),this.doProxy("true"===localStorage.getItem("proxy"))}initView(){this.myAddress&&localStorage.getItem("words")?(this.sendToView("showScreen",{name:"main",myAddress:this.myAddress}),null!==this.balance&&this.sendToView("setBalance",{balance:this.balance.toString(),txs:this.transactions})):this.sendToView("showScreen",{name:"start"}),this.sendToView("setIsMagic","true"===localStorage.getItem("magic")),this.sendToView("setIsProxy","true"===localStorage.getItem("proxy"))}update(e){(this.processingVisible&&this.sendingData||null===this.balance||e)&&this.getWallet().then(e=>{const t=this.getBalance(e),s=null===this.balance||0!==this.balance.cmp(t);this.balance=t;const a=this.checkContractInitialized(e)&&e.seqno;console.log("isBalanceChanged",s),console.log("isContractInitialized",a),!this.isContractInitialized&&a&&(this.isContractInitialized=!0),s?this.getTransactions().then(e=>{if(e.length>0){this.transactions=e;const t=e.filter(e=>Number(e.date)>this.lastTransactionTime);if(this.lastTransactionTime=Number(e[0].date),this.processingVisible&&this.sendingData)for(let e of t){const t=new d(e.to_addr).toString(!0,!0,!0),s=new d(this.sendingData.toAddress).toString(!0,!0,!0),a=e.amount,n="-"+this.sendingData.amount.toString();if(t===s&&a===n){this.sendToView("showPopup",{name:"done",message:l(this.sendingData.amount)+" TON have been sent"}),this.processingVisible=!1,this.sendingData=null;break}}}this.sendToView("setBalance",{balance:t.toString(),txs:e})}):this.sendToView("setBalance",{balance:t.toString(),txs:this.transactions})})}async showAddressOnDevice(){this.ledgerApp||await this.createLedger(localStorage.getItem("ledgerTransportType")||"hid");const{address:e}=await this.ledgerApp.getAddress(0,!0,this.ledgerApp.ADDRESS_FORMAT_USER_FRIENDLY+this.ledgerApp.ADDRESS_FORMAT_URL_SAFE+this.ledgerApp.ADDRESS_FORMAT_BOUNCEABLE);console.log(e.toString(!0,!0,!0))}async getFees(e,t,s){if(!this.isContractInitialized)return TonWeb.utils.toNano(.010966001);try{const a=await this.sign(t,e,s,null),n=(await a.estimateFee()).source_fees,o=new i(n.in_fwd_fee),r=new i(n.storage_fee),d=new i(n.gas_fee),l=new i(n.fwd_fee);return o.add(r).add(d).add(l)}catch(e){return console.error(e),new i(0)}}async showSendConfirm(e,t,s,a){if(e.lte(0)||this.balance.lt(e))return;if(!d.isValid(t))return;const n=await this.getFees(e,t,s);this.isLedger?(this.sendToView("showPopup",{name:"sendConfirm",amount:e.toString(),toAddress:t,fee:n.toString()},a),this.send(t,e,s,null)):(this.afterEnterPassword=async a=>{this.processingVisible=!0,this.sendToView("showPopup",{name:"processing"});const n=await w.wordsToPrivateKey(a);this.send(t,e,s,n)},this.sendToView("showPopup",{name:"sendConfirm",amount:e.toString(),toAddress:t,fee:n.toString()},a))}showSignConfirm(e,t){return new Promise((s,a)=>{this.isLedger?(alert("sign not supported by Ledger"),a()):(this.afterEnterPassword=async t=>{this.sendToView("closePopup");const a=await w.wordsToPrivateKey(t),n=this.rawSign(e,a);s(n)},this.sendToView("showPopup",{name:"signConfirm",data:e},t))})}async send(e,t,s,a){try{let n=0;if(this.isLedger){this.ledgerApp||await this.createLedger(localStorage.getItem("ledgerTransportType")||"hid");const t=new d(e);t.isUserFriendly&&(n+=this.ledgerApp.ADDRESS_FORMAT_USER_FRIENDLY,t.isUrlSafe&&(n+=this.ledgerApp.ADDRESS_FORMAT_URL_SAFE),t.isBounceable&&(n+=this.ledgerApp.ADDRESS_FORMAT_BOUNCEABLE),t.isTestOnly&&(n+=this.ledgerApp.ADDRESS_FORMAT_TEST_ONLY))}if(this.checkContractInitialized(await this.ton.provider.getWalletInfo(e))||(e=new d(e).toString(!0,!0,!1)),this.isLedger){let a=(await this.getWallet(this.myAddress)).seqno;a||(a=0);const o=await this.ledgerApp.transfer(0,this.walletContract,e,t,a,n);this.sendingData={toAddress:e,amount:t,comment:s,query:o},this.sendToView("showPopup",{name:"processing"}),this.processingVisible=!0,await this.sendQuery(o)}else{const n=r.sign.keyPair.fromSeed(TonWeb.utils.base64ToBytes(a)),o=await this.sign(e,t,s,n);this.sendingData={toAddress:e,amount:t,comment:s,query:o},await this.sendQuery(o)}}catch(e){console.error(e),this.sendToView("closePopup"),alert("Error sending")}}rawSign(e,t){const s=r.sign.keyPair.fromSeed(TonWeb.utils.base64ToBytes(t)),a=r.sign.detached(TonWeb.utils.hexToBytes(e),s.secretKey);return TonWeb.utils.bytesToHex(a)}async sendQuery(e){console.log("Send"),"ok"===(await e.send())["@type"]||(this.sendToView("closePopup"),alert("Send error"))}onDisconnectClick(){this.myAddress=null,this.publicKeyHex=null,this.balance=null,this.walletContract=null,this.transactions=[],this.lastTransactionTime=0,this.isContractInitialized=!1,this.sendingData=null,this.processingVisible=!1,this.isLedger=!1,this.ledgerApp=null,clearInterval(this.updateIntervalId),localStorage.clear(),this.sendToView("showScreen",{name:"start"}),this.sendToDapp("ton_accounts",[])}doMagic(e){try{this.sendToDapp("ton_doMagic",e)}catch(e){}}doProxy(e){}sendToView(e,t,s){if(window.view)window.view.onMessage(e,t);else{const o={method:e,params:t};a?a.postMessage(o):s&&n.push(o)}}onViewMessage(e,t){switch(e){case"showScreen":switch(t.name){case"created":this.showCreated();break;case"import":this.showImport();break;case"importLedger":this.importLedger(t.transportType)}break;case"import":this.import(t.words);break;case"createPrivateKey":this.createPrivateKey();break;case"passwordCreated":this.savePrivateKey(t.password);break;case"update":this.update(!0);break;case"showAddressOnDevice":this.showAddressOnDevice();break;case"onEnterPassword":this.onEnterPassword(t.password);break;case"onChangePassword":this.onChangePassword(t.oldPassword,t.newPassword);break;case"onSend":this.showSendConfirm(new i(t.amount),t.toAddress,t.comment);break;case"onBackupDone":this.onBackupDone();break;case"showMain":this.showMain();break;case"onBackupWalletClick":this.onBackupWalletClick();break;case"disconnect":this.onDisconnectClick();break;case"onClosePopup":this.processingVisible=!1;break;case"onMagicClick":localStorage.setItem("magic",t?"true":"false"),this.doMagic(t);break;case"onProxyClick":localStorage.setItem("proxy",t?"true":"false"),this.doProxy(t)}}sendToDapp(e,t){s&&s.postMessage(JSON.stringify({type:"gramWalletAPI",message:{jsonrpc:"2.0",method:e,params:t}}))}async onDappMessage(e,t){const s=!a;switch(e){case"ton_requestAccounts":return this.myAddress?[this.myAddress]:[];case"ton_getBalance":return this.balance?this.balance.toString():"";case"ton_sendTransaction":const e=t[0];return a||o(),"hex"===e.dataType?e.data=TonWeb.utils.hexToBytes(e.data):"base64"===e.dataType?e.data=TonWeb.utils.base64ToBytes(e.data):"boc"===e.dataType&&(e.data=TonWeb.boc.Cell.fromBoc(TonWeb.utils.base64ToBytes(e.data))[0]),this.showSendConfirm(new i(e.value),e.to,e.data,s),!0;case"ton_rawSign":const n=t[0];return a||o(),this.showSignConfirm(n.data,s);case"flushMemoryCache":return await chrome.webRequest.handlerBehaviorChanged(),!0}}}const g=new w;window.chrome&&chrome.runtime&&chrome.runtime.onConnect&&chrome.runtime.onConnect.addListener(e=>{"gramWalletContentScript"===e.name?(s=e,s.onMessage.addListener(async e=>{if(!e.message)return;const t=await g.onDappMessage(e.message.method,e.message.params);s&&s.postMessage(JSON.stringify({type:"gramWalletAPI",message:{jsonrpc:"2.0",id:e.message.id,method:e.message.method,result:t}}))}),s.onDisconnect.addListener(()=>{s=null}),g.initDapp()):"gramWalletPopup"===e.name&&(a=e,a.onMessage.addListener((function(e){g.onViewMessage(e.method,e.params)})),a.onDisconnect.addListener(()=>{a=null}),g.initView(),n.forEach(e=>a.postMessage(e)),n.length=0)})}]);